package at.fhjoanneum.ims.vulnerability.controller;

import at.fhjoanneum.ims.vulnerability.util.XmlParserUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.xml.sax.SAXException;

import javax.xml.parsers.SAXParser;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

@RestController
@RequestMapping("/xml")
@RequiredArgsConstructor
@Log4j2
public class XmlController {
    private final SAXParser parser;

    @PostMapping(name = "/read")
    public ResponseEntity<Void> readXML(@RequestBody String xmlInput) throws IOException, SAXException {
        log.info("Reading XML");
        File file2 = File.createTempFile("upload", ".xml");
        try (FileOutputStream output =
                     new FileOutputStream(file2)) {
            output.write(xmlInput.getBytes());
        }

        parser.parse(file2, new XmlParserUtil());
        return ResponseEntity.ok().build();
    }

    @PostMapping("/upload")
    public ResponseEntity<String> uploadFile(@RequestParam("file") MultipartFile file) throws IOException, SAXException {
        XmlParserUtil xmlParserUtil =  new XmlParserUtil();
        try {
            File file2 = File.createTempFile("upload", ".xml");
            file.transferTo(file2);
            parser.parse(file2, xmlParserUtil);
        }
        catch (Exception e) {
             // ignored exception
        }

        return ResponseEntity.ok(xmlParserUtil.getOutput());

    }
}
